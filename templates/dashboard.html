<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGINX Access Log Analyzer</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .attack-alert {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }
        .top-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .executive-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .threat-item {
            border-left: 3px solid #dc3545;
            padding: 8px;
            margin: 5px 0;
            background: #fff;
            border-radius: 4px;
        }
        .performance-metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 8px;
            margin: 5px 0;
        }
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">üöÄ NGINX Access Log Analyzer</span>
            <div class="d-flex">
                <select id="daysSelect" class="form-select me-2" style="width: auto;">
                    <option value="1">Last 1 day</option>
                    <option value="3">Last 3 days</option>
                    <option value="7" selected>Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>
                <button id="loadBtn" class="btn btn-primary me-2">Load Logs</button>
                <button id="exportBtn" class="btn btn-success">Export PDF</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading and analyzing logs...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Summary Metrics -->
            <div class="row">
                <div class="col-md-2">
                    <div class="metric-card">
                        <div class="metric-value" id="totalRequests">-</div>
                        <div>Total Requests</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <div class="metric-value" id="uniqueIPs">-</div>
                        <div>Unique IPs</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="metric-card">
                        <div class="metric-value" id="errorRate">-</div>
                        <div>Error Rate %</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="bandwidth">-</div>
                        <div>Bandwidth (MB)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="dateRange">-</div>
                        <div>Date Range</div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>Traffic Over Time</h5>
                        </div>
                        <div class="card-body">
                            <div id="trafficChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Status Code Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div id="statusChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tables Row -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h6>Top Requested Paths</h6>
                        </div>
                        <div class="card-body top-list">
                            <div id="topPaths">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h6>Top IP Addresses</h6>
                        </div>
                        <div class="card-body top-list">
                            <div id="topIPs">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h6>Top Browsers</h6>
                        </div>
                        <div class="card-body top-list">
                            <div id="topBrowsers">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h6>Hourly Traffic Distribution</h6>
                        </div>
                        <div class="card-body">
                            <div id="hourlyChart" style="height: 200px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Section -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>ü§ñ Bot vs Human Traffic Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div id="botAnalysisChart" style="height: 300px;"></div>
                            <div id="botBreakdown" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä Content Type Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div id="contentTypesChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threat Intelligence -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üõ°Ô∏è Advanced Threat Intelligence</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="alert alert-danger">
                                        <h6>HIGH RISK</h6>
                                        <div id="highRiskThreats">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="alert alert-warning">
                                        <h6>MEDIUM RISK</h6>
                                        <div id="mediumRiskThreats">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="alert alert-info">
                                        <h6>LOW RISK</h6>
                                        <div id="lowRiskThreats">Loading...</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="alert alert-secondary">
                                        <h6>INFORMATIONAL</h6>
                                        <div id="infoThreats">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Trends -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìà Performance Trends</h5>
                        </div>
                        <div class="card-body">
                            <div id="performanceTrendsChart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>‚ö° Peak Performance Hours</h5>
                        </div>
                        <div class="card-body">
                            <div id="peakHours" style="max-height: 350px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geographic Analysis -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üåç Geographic Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div id="geoChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üö® Error Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div id="errorAnalysisChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Insights -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>‚ö° Real-time Insights</h5>
                        </div>
                        <div class="card-body">
                            <div id="realTimeMetrics">
                                <div class="performance-metric">
                                    <div class="metric-value" id="recentRequests">-</div>
                                    <div>Requests (Last Hour)</div>
                                </div>
                                <div class="performance-metric">
                                    <div class="metric-value" id="recentErrors">-</div>
                                    <div>Errors (Last Hour)</div>
                                </div>
                                <div class="performance-metric">
                                    <div class="metric-value" id="trafficVelocity">-</div>
                                    <div>Traffic Velocity</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üîÆ Predictive Analytics</h5>
                        </div>
                        <div class="card-body">
                            <div id="predictiveAnalytics">Loading predictions...</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä Business Intelligence</h5>
                        </div>
                        <div class="card-body">
                            <div id="businessIntelligence">Loading BI data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Security Intelligence -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>üõ°Ô∏è Advanced Security Intelligence</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>üî¥ High Risk IPs</h6>
                                    <div id="highRiskIPs" style="max-height: 300px; overflow-y: auto;"></div>
                                </div>
                                <div class="col-md-6">
                                    <h6>üü° Medium Risk IPs</h6>
                                    <div id="mediumRiskIPs" style="max-height: 300px; overflow-y: auto;"></div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>üìã Security Recommendations</h6>
                                <div id="securityRecommendations"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>‚è∞ Attack Timeline</h5>
                        </div>
                        <div class="card-body">
                            <div id="attackTimeline" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Analytics -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìà Content Engagement</h5>
                        </div>
                        <div class="card-body">
                            <div id="contentEngagementChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üîó Traffic Sources</h5>
                        </div>
                        <div class="card-body">
                            <div id="trafficSourcesChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversion Funnel & Performance Prediction -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üéØ Conversion Funnel</h5>
                        </div>
                        <div class="card-body">
                            <div id="conversionFunnelChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìä Resource Projections</h5>
                        </div>
                        <div class="card-body">
                            <div id="resourceProjections">Loading projections...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìã Advanced Reports & Export</h5>
                        </div>
                        <div class="card-body">
                            <div class="btn-group" role="group">
                                <button id="exportDetailedBtn" class="btn btn-primary">üìä Export Detailed PDF Report</button>
                                <button id="exportThreatBtn" class="btn btn-danger">üõ°Ô∏è Export Security PDF Report</button>
                                <button id="exportPerformanceBtn" class="btn btn-success">‚ö° Export Performance PDF Report</button>
                                <button id="generateSummaryBtn" class="btn btn-info">üìÑ Generate Executive Summary</button>
                                <button id="exportComprehensiveBtn" class="btn btn-warning">üöÄ Export Comprehensive PDF Report</button>
                            </div>
                            <div id="reportSummary" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Alerts & Suspicious Activity -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üîí Security Alerts & Suspicious Activity</h5>
                        </div>
                        <div class="card-body">
                            <div id="securityAlerts">Loading security analysis...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // Basic utility functions for data handling (non-blocking versions)
        function sanitizeForDisplay(data) {
            // Simple pass-through function - no aggressive blocking
            return data;
        }

        function escapeHtml(text) {
            // Basic HTML escaping without aggressive pattern removal
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function showLoading() {
            $('#loading').show();
            $('#content').hide();
        }

        function hideLoading() {
            $('#loading').hide();
            $('#content').show();
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function loadLogs() {
            showLoading();
            const days = $('#daysSelect').val();
            
            $.get('/api/load_logs', {days: days})
                .done(function(data) {
                    console.log('Logs loaded:', data.logs_loaded);
                    loadDashboardData();
                })
                .fail(function() {
                    console.error('Failed to load logs');
                    hideLoading();
                });
        }

        function loadDashboardData() {
            // Load summary data
            $.get('/api/summary')
                .done(function(data) {
                    // Sanitize all incoming data
                    currentData = sanitizeForDisplay(data);
                    updateSummaryMetrics(currentData);
                    updateTopLists(currentData);
                    loadCharts();
                    loadSecurityAlerts();
                    loadAdvancedAnalytics();
                    loadThreatIntelligence();
                    loadPerformanceMetrics();
                    loadRealTimeInsights();
                    loadPredictiveAnalytics();
                    loadSecurityIntelligence();
                    loadBusinessIntelligence();
                    hideLoading();
                })
                .fail(function() {
                    console.error('Failed to load summary data');
                    hideLoading();
                });
        }

        function updateSummaryMetrics(data) {
            $('#totalRequests').text(formatNumber(data.total_requests || 0));
            $('#uniqueIPs').text(formatNumber(data.unique_ips || 0));
            $('#errorRate').text(data.error_rate || 0);
            $('#bandwidth').text(data.bandwidth_mb || 0);
            $('#dateRange').text(data.date_range || 'No data');
        }

        function updateTopLists(data) {
            // Top Paths - Use DOM manipulation instead of HTML injection
            const pathsContainer = $('#topPaths');
            pathsContainer.empty();
            
            const pathEntries = Object.entries(data.top_paths || {});
            if (pathEntries.length === 0) {
                pathsContainer.text('No data');
            } else {
                pathEntries.forEach(([path, count]) => {
                    const div = $('<div class="d-flex justify-content-between">');
                    const pathSpan = $('<span class="text-truncate">').text(path).attr('title', path);
                    const countBadge = $('<span class="badge bg-primary">').text(count);
                    div.append(pathSpan, countBadge);
                    pathsContainer.append(div);
                });
            }

            // Top IPs - Safe DOM manipulation
            const ipsContainer = $('#topIPs');
            ipsContainer.empty();
            
            const ipEntries = Object.entries(data.top_ips || {});
            if (ipEntries.length === 0) {
                ipsContainer.text('No data');
            } else {
                ipEntries.forEach(([ip, count]) => {
                    const div = $('<div class="d-flex justify-content-between">');
                    const ipSpan = $('<span>').text(ip);
                    const countBadge = $('<span class="badge bg-warning">').text(count);
                    div.append(ipSpan, countBadge);
                    ipsContainer.append(div);
                });
            }

            // Top Browsers - Safe DOM manipulation
            const browsersContainer = $('#topBrowsers');
            browsersContainer.empty();
            
            const browserEntries = Object.entries(data.top_user_agents || {});
            if (browserEntries.length === 0) {
                browsersContainer.text('No data');
            } else {
                browserEntries.forEach(([browser, count]) => {
                    const div = $('<div class="d-flex justify-content-between">');
                    const browserSpan = $('<span class="text-truncate">').text(browser).attr('title', browser);
                    const countBadge = $('<span class="badge bg-info">').text(count);
                    div.append(browserSpan, countBadge);
                    browsersContainer.append(div);
                });
            }
        }

        function loadCharts() {
            // Traffic over time chart
            $.get('/api/traffic_over_time')
                .done(function(data) {
                    const trace = {
                        x: data.timestamps,
                        y: data.requests,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Requests',
                        line: {color: '#17a2b8'}
                    };

                    const layout = {
                        title: 'Requests Over Time',
                        xaxis: {title: 'Time'},
                        yaxis: {title: 'Number of Requests'},
                        margin: {t: 40, r: 20, b: 40, l: 60}
                    };

                    Plotly.newPlot('trafficChart', [trace], layout, {responsive: true});
                });

            // Status code distribution
            $.get('/api/status_distribution')
                .done(function(data) {
                    const trace = {
                        labels: data.labels,
                        values: data.values,
                        type: 'pie',
                        hole: 0.4,
                        textinfo: 'label+percent'
                    };

                    const layout = {
                        title: 'HTTP Status Codes',
                        margin: {t: 40, r: 20, b: 40, l: 20}
                    };

                    Plotly.newPlot('statusChart', [trace], layout, {responsive: true});
                });

            // Hourly traffic distribution
            if (currentData && currentData.hourly_traffic) {
                const hours = Object.keys(currentData.hourly_traffic).map(h => parseInt(h));
                const counts = Object.values(currentData.hourly_traffic);

                const trace = {
                    x: hours,
                    y: counts,
                    type: 'bar',
                    marker: {color: '#28a745'}
                };

                const layout = {
                    title: 'Traffic by Hour',
                    xaxis: {title: 'Hour of Day'},
                    yaxis: {title: 'Requests'},
                    margin: {t: 40, r: 20, b: 40, l: 60}
                };

                Plotly.newPlot('hourlyChart', [trace], layout, {responsive: true});
            }
        }

        function loadSecurityAlerts() {
            $.get('/api/attacks')
                .done(function(data) {
                    // Sanitize the entire data structure first
                    const sanitizedData = sanitizeForDisplay(data);
                    
                    const alertsContainer = $('#securityAlerts');
                    alertsContainer.empty();
                    
                    if (!sanitizedData || sanitizedData.length === 0) {
                        const successAlert = $('<div class="alert alert-success">').text('‚úÖ No suspicious activity detected');
                        alertsContainer.append(successAlert);
                    } else {
                        sanitizedData.forEach(function(alert) {
                            // Create safe DOM elements
                            const alertDiv = $('<div class="attack-alert">');
                            
                            const title = $('<h6>').text('üö® ' + (alert.type || 'Unknown'));
                            const countP = $('<p>').append(
                                $('<strong>').text('Count: '),
                                document.createTextNode((alert.count || 0) + ' occurrences')
                            );
                            
                            const urlsP = $('<p>').append($('<strong>').text('Sample URLs:'));
                            const urlsList = $('<ul>');
                            
                            if (alert.sample_urls && Array.isArray(alert.sample_urls)) {
                                alert.sample_urls.forEach(url => {
                                    const li = $('<li>');
                                    const code = $('<code>').text(url);
                                    li.append(code);
                                    urlsList.append(li);
                                });
                            }
                            
                            alertDiv.append(title, countP, urlsP, urlsList);
                            alertsContainer.append(alertDiv);
                        });
                    }
                })
                .fail(function() {
                    const errorAlert = $('<div class="alert alert-warning">').text('Failed to load security data');
                    $('#securityAlerts').html(errorAlert);
                });
        }

        function loadAdvancedAnalytics() {
            $.get('/api/advanced_analytics')
                .done(function(data) {
                    // Bot vs Human Traffic
                    if (data.bot_analysis) {
                        const botData = data.bot_analysis;
                        const botTrace = {
                            labels: ['Human Traffic', ...Object.keys(botData.bot_categories)],
                            values: [botData.human_traffic, ...Object.values(botData.bot_categories)],
                            type: 'pie',
                            hole: 0.4,
                            textinfo: 'label+percent',
                            marker: {
                                colors: ['#28a745', '#dc3545', '#fd7e14', '#6f42c1', '#20c997', '#6c757d']
                            }
                        };

                        const botLayout = {
                            title: 'Traffic Classification',
                            margin: {t: 40, r: 20, b: 40, l: 20}
                        };

                        Plotly.newPlot('botAnalysisChart', [botTrace], botLayout, {responsive: true});

                        // Bot breakdown text - Safe DOM manipulation
                        const botContainer = $('#botBreakdown');
                        botContainer.empty();
                        
                        const botP = $('<p>').append(
                            $('<strong>').text('Bot Traffic: '),
                            document.createTextNode(botData.bot_percentage + '% (' + botData.total_bots + ' requests)')
                        );
                        
                        const humanP = $('<p>').append(
                            $('<strong>').text('Human Traffic: '),
                            document.createTextNode((100 - botData.bot_percentage).toFixed(1) + '% (' + botData.human_traffic + ' requests)')
                        );
                        
                        botContainer.append(botP, humanP);
                    }

                    // Content Types
                    if (data.content_types) {
                        const contentTrace = {
                            labels: Object.keys(data.content_types),
                            values: Object.values(data.content_types),
                            type: 'pie',
                            textinfo: 'label+percent'
                        };

                        const contentLayout = {
                            title: 'Request Types',
                            margin: {t: 40, r: 20, b: 40, l: 20}
                        };

                        Plotly.newPlot('contentTypesChart', [contentTrace], contentLayout, {responsive: true});
                    }

                    // Geographic Distribution
                    if (data.geographic) {
                        const geoTrace = {
                            x: Object.keys(data.geographic),
                            y: Object.values(data.geographic),
                            type: 'bar',
                            marker: {color: '#17a2b8'}
                        };

                        const geoLayout = {
                            title: 'Geographic Distribution',
                            xaxis: {title: 'Region'},
                            yaxis: {title: 'Requests'},
                            margin: {t: 40, r: 20, b: 40, l: 60}
                        };

                        Plotly.newPlot('geoChart', [geoTrace], geoLayout, {responsive: true});
                    }

                    // Error Analysis
                    if (data.error_breakdown) {
                        const errorData = [];
                        const errorLabels = [];
                        
                        Object.entries(data.error_breakdown).forEach(([range, statuses]) => {
                            Object.entries(statuses).forEach(([status, count]) => {
                                errorLabels.push(status + ' (' + range + ')');
                                errorData.push(count);
                            });
                        });

                        if (errorData.length > 0) {
                            const errorTrace = {
                                x: errorLabels,
                                y: errorData,
                                type: 'bar',
                                marker: {color: '#dc3545'}
                            };

                            const errorLayout = {
                                title: 'Error Status Codes',
                                xaxis: {title: 'Status Code'},
                                yaxis: {title: 'Count'},
                                margin: {t: 40, r: 20, b: 40, l: 60}
                            };

                            Plotly.newPlot('errorAnalysisChart', [errorTrace], errorLayout, {responsive: true});
                        }
                    }
                });
        }

        function loadThreatIntelligence() {
            $.get('/api/threat_intelligence')
                .done(function(data) {
                    // High Risk Threats - Safe DOM manipulation
                    const highRiskContainer = $('#highRiskThreats');
                    highRiskContainer.empty();
                    
                    if (data.high_risk && data.high_risk.length > 0) {
                        data.high_risk.forEach(threat => {
                            const div = $('<div class="mb-2">');
                            const strong = $('<strong>').text(threat.type || 'Unknown');
                            const br = $('<br>');
                            const small = $('<small>').text('Count: ' + (threat.count || 0));
                            div.append(strong, br, small);
                            highRiskContainer.append(div);
                        });
                    } else {
                        highRiskContainer.append($('<small>').text('No high-risk threats detected'));
                    }

                    // Medium Risk Threats - Safe DOM manipulation
                    const mediumRiskContainer = $('#mediumRiskThreats');
                    mediumRiskContainer.empty();
                    
                    if (data.medium_risk && data.medium_risk.length > 0) {
                        data.medium_risk.forEach(threat => {
                            const div = $('<div class="mb-2">');
                            const strong = $('<strong>').text(threat.type || 'Unknown');
                            const br = $('<br>');
                            const small = $('<small>').text('Count: ' + (threat.count || 0));
                            div.append(strong, br, small);
                            mediumRiskContainer.append(div);
                        });
                    } else {
                        mediumRiskContainer.append($('<small>').text('No medium-risk threats detected'));
                    }

                    // Low Risk Threats - Safe DOM manipulation
                    const lowRiskContainer = $('#lowRiskThreats');
                    lowRiskContainer.empty();
                    
                    if (data.low_risk && data.low_risk.length > 0) {
                        data.low_risk.forEach(threat => {
                            const div = $('<div class="mb-2">');
                            const strong = $('<strong>').text(threat.type || 'Unknown');
                            const br = $('<br>');
                            const small = $('<small>').text('Count: ' + (threat.count || 0));
                            div.append(strong, br, small);
                            lowRiskContainer.append(div);
                        });
                    } else {
                        lowRiskContainer.append($('<small>').text('No low-risk threats detected'));
                    }

                    // Informational
                    $('#infoThreats').html('<small>Threat analysis complete</small>');
                });
        }

        function loadPerformanceMetrics() {
            $.get('/api/performance_metrics')
                .done(function(data) {
                    // Performance Trends
                    if (data.daily_trends && data.daily_trends.length > 0) {
                        const dates = data.daily_trends.map(d => d.date);
                        
                        const requestsTrace = {
                            x: dates,
                            y: data.daily_trends.map(d => d.requests),
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Requests',
                            yaxis: 'y'
                        };

                        const bandwidthTrace = {
                            x: dates,
                            y: data.daily_trends.map(d => d.bandwidth_mb),
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Bandwidth (MB)',
                            yaxis: 'y2'
                        };

                        const errorTrace = {
                            x: dates,
                            y: data.daily_trends.map(d => d.error_rate),
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: 'Error Rate (%)',
                            yaxis: 'y3'
                        };

                        const layout = {
                            title: 'Daily Performance Trends',
                            xaxis: {title: 'Date'},
                            yaxis: {
                                title: 'Requests',
                                side: 'left'
                            },
                            yaxis2: {
                                title: 'Bandwidth (MB)',
                                overlaying: 'y',
                                side: 'right'
                            },
                            yaxis3: {
                                title: 'Error Rate (%)',
                                overlaying: 'y',
                                side: 'right',
                                position: 0.85
                            },
                            margin: {t: 40, r: 100, b: 40, l: 60}
                        };

                        Plotly.newPlot('performanceTrendsChart', [requestsTrace, bandwidthTrace, errorTrace], layout, {responsive: true});
                    }

                    // Peak Hours - Safe DOM manipulation
                    if (data.peak_hours && data.peak_hours.length > 0) {
                        const peakContainer = $('#peakHours');
                        peakContainer.empty();
                        
                        const listGroup = $('<div>').addClass('list-group');
                        
                        data.peak_hours.slice(0, 10).forEach((peak, index) => {
                            const item = $('<div>').addClass('list-group-item d-flex justify-content-between align-items-center');
                            
                            const leftDiv = $('<div>').append(
                                $('<strong>').text(peak.date + ' ' + peak.hour),
                                $('<br>'),
                                $('<small>').text(peak.bandwidth_mb + ' MB transferred')
                            );
                            
                            const badge = $('<span>').addClass('badge bg-primary rounded-pill').text(peak.requests);
                            
                            item.append(leftDiv, badge);
                            listGroup.append(item);
                        });
                        
                        peakContainer.append(listGroup);
                    }
                });
        }

        function exportDetailedReport() {
            window.open('/api/export/pdf/summary', '_blank');
        }

        function exportThreatReport() {
            window.open('/api/export/pdf/security', '_blank');
        }

        function exportPerformanceReport() {
            window.open('/api/export/pdf/summary', '_blank');
        }

        function generateExecutiveSummary() {
            Promise.all([
                $.get('/api/summary'),
                $.get('/api/advanced_analytics'),
                $.get('/api/threat_intelligence'),
                $.get('/api/performance_metrics')
            ]).then(function([summary, analytics, threats, performance]) {
                const totalThreats = (threats.high_risk?.length || 0) + 
                                  (threats.medium_risk?.length || 0) + 
                                  (threats.low_risk?.length || 0);

                // Executive Summary - Safe DOM manipulation
                const executiveContainer = $('#reportSummary');
                executiveContainer.empty();
                
                const summaryDiv = $('<div>').addClass('executive-summary');
                const title = $('<h5>').text('üìã Executive Summary');
                const row = $('<div>').addClass('row');
                
                // Traffic Overview
                const trafficCol = $('<div>').addClass('col-md-6');
                const trafficTitle = $('<h6>').text('Traffic Overview');
                const trafficList = $('<ul>');
                
                trafficList.append(
                    $('<li>').append($('<strong>').text('Total Requests: '), document.createTextNode(formatNumber(summary.total_requests || 0))),
                    $('<li>').append($('<strong>').text('Unique Visitors: '), document.createTextNode(formatNumber(summary.unique_ips || 0))),
                    $('<li>').append($('<strong>').text('Error Rate: '), document.createTextNode((summary.error_rate || 0) + '%')),
                    $('<li>').append($('<strong>').text('Bandwidth: '), document.createTextNode((summary.bandwidth_mb || 0) + ' MB')),
                    $('<li>').append($('<strong>').text('Bot Traffic: '), document.createTextNode((analytics.bot_analysis?.bot_percentage || 0) + '%'))
                );
                
                trafficCol.append(trafficTitle, trafficList);
                
                // Security Assessment
                const securityCol = $('<div>').addClass('col-md-6');
                const securityTitle = $('<h6>').text('Security Assessment');
                const securityList = $('<ul>');
                
                const riskLevel = totalThreats > 10 ? 'HIGH' : totalThreats > 5 ? 'MEDIUM' : 'LOW';
                
                securityList.append(
                    $('<li>').append($('<strong>').text('High Risk Threats: '), document.createTextNode(threats.high_risk?.length || 0)),
                    $('<li>').append($('<strong>').text('Medium Risk Threats: '), document.createTextNode(threats.medium_risk?.length || 0)),
                    $('<li>').append($('<strong>').text('Low Risk Threats: '), document.createTextNode(threats.low_risk?.length || 0)),
                    $('<li>').append($('<strong>').text('Total Security Alerts: '), document.createTextNode(totalThreats)),
                    $('<li>').append($('<strong>').text('Risk Level: '), document.createTextNode(riskLevel))
                );
                
                securityCol.append(securityTitle, securityList);
                row.append(trafficCol, securityCol);
                
                // Recommendations
                const recommendations = $('<div>').addClass('mt-3');
                const recTitle = $('<h6>').text('Key Recommendations');
                const recList = $('<ul>');
                
                if (totalThreats > 0) {
                    recList.append($('<li>').text('Review and address identified security threats'));
                } else {
                    recList.append($('<li>').text('‚úÖ No immediate security concerns detected'));
                }
                
                if (summary.error_rate > 10) {
                    recList.append($('<li>').text('‚ö†Ô∏è High error rate detected - investigate server issues'));
                } else {
                    recList.append($('<li>').text('‚úÖ Error rate within acceptable limits'));
                }
                
                if (analytics.bot_analysis?.bot_percentage > 70) {
                    recList.append($('<li>').text('‚ö†Ô∏è High bot traffic - consider implementing bot protection'));
                } else {
                    recList.append($('<li>').text('‚úÖ Bot traffic levels normal'));
                }
                
                recList.append(
                    $('<li>').text('Continue monitoring for unusual patterns'),
                    $('<li>').text('Regular security audits recommended')
                );
                
                recommendations.append(recTitle, recList);
                summaryDiv.append(title, row, recommendations);
                executiveContainer.append(summaryDiv).show();
            });
        }

        function loadRealTimeInsights() {
            $.get('/api/real_time_insights')
                .done(function(data) {
                    if (data.recent_activity) {
                        $('#recentRequests').text(formatNumber(data.recent_activity.requests_last_hour || 0));
                        $('#recentErrors').text(formatNumber(data.recent_activity.errors_last_hour || 0));
                    }
                    
                    if (data.traffic_velocity) {
                        const velocity = data.traffic_velocity;
                        let velocityText = velocity.avg_requests_per_hour + '/hr';
                        if (velocity.anomaly_detected) {
                            velocityText += ' ‚ö†Ô∏è';
                        }
                        $('#trafficVelocity').text(velocityText);
                    }
                });
        }

        function loadPredictiveAnalytics() {
            $.get('/api/predictive_analytics')
                .done(function(data) {
                    const predictiveContainer = $('#predictiveMetrics');
                    predictiveContainer.empty();
                    
                    if (data.traffic_prediction) {
                        const trafficDiv = $('<div>').addClass('performance-metric');
                        const trafficValue = $('<div>').addClass('metric-value').text(data.traffic_prediction.predicted_next_hour_requests);
                        const trafficLabel = $('<div>').text('Predicted Next Hour');
                        trafficDiv.append(trafficValue, trafficLabel);
                        predictiveContainer.append(trafficDiv);
                    }
                    
                    if (data.trend_analysis) {
                        const trend = data.trend_analysis;
                        const trendIcon = trend.trend_direction === 'increasing' ? 'üìà' : 
                                        trend.trend_direction === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                        
                        const trendDiv = $('<div>').addClass('performance-metric');
                        const trendValue = $('<div>').addClass('metric-value').text(trendIcon);
                        const trendLabel = $('<div>').text(trend.trend_direction + ' (' + trend.trend_strength + ')');
                        trendDiv.append(trendValue, trendLabel);
                        predictiveContainer.append(trendDiv);
                    }
                    
                    // Resource projections
                    if (data.resource_projection) {
                        const proj = data.resource_projection;
                        const resourceContainer = $('#resourceProjections');
                        resourceContainer.empty();
                        
                        const bandwidthDiv = $('<div>').addClass('performance-metric');
                        const bandwidthValue = $('<div>').addClass('metric-value').text(proj.monthly_bandwidth_projection_gb);
                        const bandwidthLabel = $('<div>').text('Monthly Bandwidth (GB)');
                        bandwidthDiv.append(bandwidthValue, bandwidthLabel);
                        
                        const storageDiv = $('<div>').addClass('performance-metric');
                        const storageValue = $('<div>').addClass('metric-value').text(proj.storage_requirement_estimate_gb);
                        const storageLabel = $('<div>').text('Storage Needed (GB)');
                        storageDiv.append(storageValue, storageLabel);
                        
                        resourceContainer.append(bandwidthDiv, storageDiv);
                    }
                });
        }

        function loadSecurityIntelligence() {
            $.get('/api/security_intelligence')
                .done(function(data) {
                    // High Risk IPs - Safe DOM manipulation
                    const highRiskContainer = $('#highRiskIPs');
                    highRiskContainer.empty();
                    
                    if (data.ip_risk_analysis && data.ip_risk_analysis.high_risk_ips.length > 0) {
                        data.ip_risk_analysis.high_risk_ips.forEach(ip => {
                            const threatItem = $('<div>').addClass('threat-item');
                            
                            const ipStrong = $('<strong>').text(ip.ip + ' (Score: ' + ip.risk_score + ')');
                            const requestsSmall = $('<small>').text('Requests: ' + ip.total_requests + ', Failure: ' + ip.failure_rate);
                            const factorsSmall = $('<small>').text(ip.risk_factors.slice(0, 2).join(', '));
                            
                            threatItem.append(ipStrong, $('<br>'), requestsSmall, $('<br>'), factorsSmall);
                            highRiskContainer.append(threatItem);
                        });
                    } else {
                        const noRiskMsg = $('<small>').addClass('text-muted').text('No high-risk IPs detected');
                        highRiskContainer.append(noRiskMsg);
                    }

                    // Medium Risk IPs - Safe DOM manipulation
                    const mediumRiskContainer = $('#mediumRiskIPs');
                    mediumRiskContainer.empty();
                    
                    if (data.ip_risk_analysis && data.ip_risk_analysis.medium_risk_ips.length > 0) {
                        data.ip_risk_analysis.medium_risk_ips.forEach(ip => {
                            const threatItem = $('<div>').addClass('threat-item');
                            
                            const ipStrong = $('<strong>').text(ip.ip + ' (Score: ' + ip.risk_score + ')');
                            const requestsSmall = $('<small>').text('Requests: ' + ip.total_requests + ', Failure: ' + ip.failure_rate);
                            
                            threatItem.append(ipStrong, $('<br>'), requestsSmall);
                            mediumRiskContainer.append(threatItem);
                        });
                    } else {
                        const noMediumRiskMsg = $('<small>').addClass('text-muted').text('No medium-risk IPs detected');
                        mediumRiskContainer.append(noMediumRiskMsg);
                    }

                    // Security Recommendations
                    let recHtml = '';
                    if (data.security_recommendations && data.security_recommendations.length > 0) {
                        data.security_recommendations.forEach(rec => {
                            const badgeClass = rec.priority === 'HIGH' ? 'bg-danger' : 'bg-warning';
                            recHtml += `
                                <div class="alert alert-${rec.priority === 'HIGH' ? 'danger' : 'warning'} alert-dismissible">
                                    <span class="badge ${badgeClass}">${rec.priority}</span>
                                    <strong>${rec.category}:</strong> ${rec.description}<br>
                                    <small><strong>Action:</strong> ${rec.action}</small>
                                </div>
                            `;
                        });
                    } else {
                        recHtml = '<div class="alert alert-success">‚úÖ No security recommendations at this time</div>';
                    }
                    $('#securityRecommendations').html(recHtml);

                    // Attack Timeline - Safe DOM manipulation
                    const timelineContainer = $('#attackTimeline');
                    timelineContainer.empty();
                    
                    if (data.attack_timeline && data.attack_timeline.length > 0) {
                        data.attack_timeline.forEach(attack => {
                            const date = new Date(attack.timestamp);
                            
                            // Create elements safely
                            const threatItem = $('<div>').addClass('threat-item');
                            const timeElement = $('<small>').text(date.toLocaleString());
                            const ipElement = $('<strong>').text(attack.ip);
                            const urlElement = $('<code>').text(attack.url.substring(0, 50) + '...');
                            const statusBadge = $('<span>')
                                .addClass('badge bg-danger')
                                .text('Status: ' + attack.status);
                            
                            // Assemble the timeline item
                            threatItem.append(timeElement)
                                     .append($('<br>'))
                                     .append(ipElement)
                                     .append($('<br>'))
                                     .append(urlElement)
                                     .append($('<br>'))
                                     .append(statusBadge);
                            
                            timelineContainer.append(threatItem);
                        });
                    } else {
                        timelineContainer.append($('<small>').addClass('text-muted').text('No recent attacks detected'));
                    }
                });
        }

        function loadBusinessIntelligence() {
            $.get('/api/business_intelligence')
                .done(function(data) {
                    // Business Intelligence Summary - Safe DOM manipulation
                    const biContainer = $('#businessIntelligence');
                    biContainer.empty();
                    
                    if (data.content_analytics) {
                        const analytics = data.content_analytics;
                        
                        const pagesMetric = $('<div>').addClass('performance-metric');
                        pagesMetric.append(
                            $('<div>').addClass('metric-value').text(analytics.pages_per_visitor),
                            $('<div>').text('Pages per Visitor')
                        );
                        
                        const visitorsMetric = $('<div>').addClass('performance-metric');
                        visitorsMetric.append(
                            $('<div>').addClass('metric-value').text(analytics.unique_visitors),
                            $('<div>').text('Unique Visitors')
                        );
                        
                        biContainer.append(pagesMetric, visitorsMetric);
                    }

                    // Content Engagement Chart
                    if (data.content_analytics && data.content_analytics.top_content.length > 0) {
                        const content = data.content_analytics.top_content.slice(0, 10);
                        const contentTrace = {
                            x: content.map(c => c.path.substring(0, 30) + (c.path.length > 30 ? '...' : '')),
                            y: content.map(c => c.engagement_score),
                            type: 'bar',
                            marker: {color: '#28a745'},
                            text: content.map(c => 'Views: ' + c.views + ', Visitors: ' + c.unique_visitors),
                            textposition: 'outside'
                        };

                        const contentLayout = {
                            title: 'Top Content by Engagement',
                            xaxis: {title: 'Content Path'},
                            yaxis: {title: 'Engagement Score'},
                            margin: {t: 40, r: 20, b: 100, l: 60}
                        };

                        Plotly.newPlot('contentEngagementChart', [contentTrace], contentLayout, {responsive: true});
                    }

                    // Traffic Sources Chart
                    if (data.traffic_sources) {
                        const sourceTrace = {
                            labels: Object.keys(data.traffic_sources),
                            values: Object.values(data.traffic_sources),
                            type: 'pie',
                            textinfo: 'label+percent'
                        };

                        const sourceLayout = {
                            title: 'Traffic Sources',
                            margin: {t: 40, r: 20, b: 40, l: 20}
                        };

                        Plotly.newPlot('trafficSourcesChart', [sourceTrace], sourceLayout, {responsive: true});
                    }

                    // Conversion Funnel
                    if (data.conversion_funnel) {
                        const funnel = data.conversion_funnel;
                        const funnelTrace = {
                            x: Object.keys(funnel),
                            y: Object.values(funnel),
                            type: 'bar',
                            marker: {
                                color: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                            }
                        };

                        const funnelLayout = {
                            title: 'User Journey Funnel',
                            xaxis: {title: 'Funnel Step'},
                            yaxis: {title: 'Count'},
                            margin: {t: 40, r: 20, b: 40, l: 60}
                        };

                        Plotly.newPlot('conversionFunnelChart', [funnelTrace], funnelLayout, {responsive: true});
                    }
                });
        }

        function exportComprehensiveReport() {
            window.open('/api/export/pdf/comprehensive', '_blank');
        }

        function exportData() {
            window.open('/api/export/pdf/summary', '_blank');
        }

        // Comprehensive security check on page load
        function initializeSecurity() {
            // Disable eval and other dangerous functions
            window.eval = function() {
                console.error('eval() has been disabled for security');
                return null;
            };
            
            // Monitor for script injection attempts
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // Check for script tags
                            if (node.tagName === 'SCRIPT') {
                                console.error('Script injection attempt blocked:', node);
                                node.remove();
                            }
                            
                            // Check for dangerous attributes
                            if (node.attributes) {
                                Array.from(node.attributes).forEach(attr => {
                                    if (attr.name.startsWith('on') || attr.value.includes('javascript:')) {
                                        console.error('Dangerous attribute blocked:', attr.name, attr.value);
                                        node.removeAttribute(attr.name);
                                    }
                                });
                            }
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true
            });
        }

        // Event handlers
        $(document).ready(function() {
            // Initialize security first
            initializeSecurity();
            
            $('#loadBtn').click(loadLogs);
            $('#exportBtn').click(exportData);
            $('#exportDetailedBtn').click(exportDetailedReport);
            $('#exportThreatBtn').click(exportThreatReport);
            $('#exportPerformanceBtn').click(exportPerformanceReport);
            $('#generateSummaryBtn').click(generateExecutiveSummary);
            $('#exportComprehensiveBtn').click(exportComprehensiveReport);
            
            // Auto-load on page load
            loadLogs();
        });
    </script>
</body>
</html>